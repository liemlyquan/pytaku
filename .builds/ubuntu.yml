image: ubuntu/bionic

secrets:
  # Github deploy key: solely for mirroring to github
  - 89816c8b-4416-4a78-84ee-3ad77b485912
  # PyPI token for pytaku:
  - 8c42b8a6-d1b7-4af7-82f2-b8f1b6e085e2

environment:
  # Ugly hack to prepend to PATH:
  #   ~/.poetry/bin - for poetry (duh)
  #   ~/.local/bin - for entrypoint scripts that poetry installs
  PATH: /home/build/.poetry/bin:/home/build/.local/bin:/usr/local/bin:/usr/bin:/bin:/usr/games

packages:
  - curl
  - python3.7-dev
  - python3.7-venv
  - python3-pip

tasks:
  - mirror-to-github: |
      cd pytaku
      mkdir -p ~/.ssh
      echo -e "\nHost github.com\n  IdentityFile /home/build/.ssh/89816c8b-4416-4a78-84ee-3ad77b485912\n  IdentitiesOnly yes\n  BatchMode yes" >> ~/.ssh/config
      echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==" >> ~/.ssh/known_hosts
      git remote add github git@github.com:nhanb/pytaku.git
      git push -f github '*:*' --follow-tags

  - setup: |
      python3.7 -m venv ~/venv
      source ~/venv/bin/activate
      curl https://raw.githubusercontent.com/python-poetry/poetry/master/get-poetry.py -o get-poetry.py
      python get-poetry.py -y
      cd pytaku
      poetry install

  - build: |
      cd pytaku
      source ~/venv/bin/activate
      poetry build

  # Builds.sr.ht doesn't support tag or even branch detection yet:
  # > https://todo.sr.ht/~sircmpwn/builds.sr.ht/170
  # Also the yaml gets mangled badly whenever I try to use a pipe
  # operator, so I'm moving the whole tag detection thing into a
  # bash script.
  - check-publish: |
      if [[ "$GITHUB_EVENT" == "push" ]] && [[ "$GITHUB_REF" =~ ^refs/tags/ ]]
      then
          echo "This is a tag push. Proceeding to publish..."
      else
          echo "Not deploying."
          complete-build  # stop build with a "success" status
      fi

  - publish: |
      cd pytaku
      poetry publish
